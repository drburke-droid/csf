<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>BurkeCSF</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,200;9..40,300;9..40,400;9..40,500;9..40,600&family=JetBrains+Mono:wght@200;300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--a:#00ffcc;--ag:rgba(0,255,204,.2);--as:rgba(0,255,204,.08);--c:#0a0a0c;--s:rgba(255,255,255,.03);--s2:rgba(255,255,255,.06);--b:rgba(255,255,255,.06);--t1:rgba(255,255,255,.88);--t2:rgba(255,255,255,.4);--t3:rgba(255,255,255,.18);--e:#ff453a;--f:'DM Sans',-apple-system,system-ui,sans-serif;--m:'JetBrains Mono','SF Mono',monospace;--ez:cubic-bezier(.4,0,.2,1)}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:var(--c);color:var(--t1);font-family:var(--f);-webkit-font-smoothing:antialiased;height:100vh;height:100dvh;overflow:hidden;display:flex;flex-direction:column;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
.hdr{display:flex;justify-content:space-between;align-items:center;padding:14px 20px 6px;flex-shrink:0}
.brand{font-size:1rem;font-weight:200;letter-spacing:-.3px;color:var(--t2)}
.prog{display:flex;justify-content:center;padding:4px 0 8px;flex-shrink:0}
.ring{position:relative;width:52px;height:52px}
.ring svg{width:52px;height:52px;transform:rotate(-90deg)}
.ring .bg{fill:none;stroke:var(--s2);stroke-width:2.5}.ring .fg{fill:none;stroke:var(--a);stroke-width:2.5;stroke-linecap:round;stroke-dasharray:131.9;stroke-dashoffset:131.9;transition:stroke-dashoffset .5s var(--ez)}
.ring .num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--m);font-size:.7rem;color:var(--t2)}
/* ‚îÄ‚îÄ Response area ‚îÄ‚îÄ */
.resp{flex:1;display:flex;align-items:center;justify-content:center;padding:0 16px;overflow:hidden;position:relative}
.prompt{text-align:center;font-family:var(--m);font-size:.6rem;font-weight:300;letter-spacing:2px;text-transform:uppercase;color:var(--t3);animation:br 3s ease-in-out infinite;position:absolute}
@keyframes br{0%,100%{opacity:.3}50%{opacity:.7}}
/* Orientation + No Target buttons */
.ori-pad{display:flex;flex-direction:column;gap:10px;width:min(92vw,360px)}
.ori-row{display:flex;gap:10px}
.ori-btn{flex:1;padding:22px 10px;border-radius:18px;border:1.5px solid var(--b);background:var(--s);font-family:var(--f);font-size:1.4rem;color:var(--t1);cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .12s var(--ez);touch-action:manipulation;text-align:center;display:flex;flex-direction:column;align-items:center;gap:2px}
.ori-btn:active{transform:scale(.95);background:var(--as);border-color:var(--a);color:var(--a)}
.ori-lbl{font-family:var(--m);font-size:.45rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-top:2px}
.no-btn{padding:18px 20px;border-radius:18px;border:1.5px solid rgba(255,255,255,.04);background:rgba(255,255,255,.015);font-family:var(--f);font-size:1rem;color:var(--t2);cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .12s var(--ez);touch-action:manipulation;text-align:center;letter-spacing:.5px}
.no-btn:active{transform:scale(.97);background:rgba(255,69,58,.06);border-color:rgba(255,69,58,.2);color:var(--e)}
.fl{animation:fl .3s ease-out}
@keyframes fl{0%{background:var(--as);border-color:var(--a);color:var(--a);box-shadow:0 0 14px var(--ag)}100%{background:var(--s);border-color:var(--b);color:var(--t1);box-shadow:none}}
.hid{display:none!important}
.sbar{padding:10px 20px;text-align:center;flex-shrink:0}
#stt{font-family:var(--m);font-size:.5rem;font-weight:300;letter-spacing:2px;text-transform:uppercase;color:var(--t3)}
.sd{display:inline-block;width:5px;height:5px;border-radius:50%;margin-right:5px;vertical-align:middle}
.sd.ok{background:var(--a);animation:pls 2s ease-in-out infinite}.sd.er{background:var(--e)}
@keyframes pls{0%,100%{opacity:1}50%{opacity:.3}}
.rbtn{display:none;margin-top:10px;background:0;color:var(--t3);border:1px solid var(--b);padding:7px 18px;border-radius:100px;cursor:pointer;font-family:var(--f);font-size:.75rem}
/* ‚îÄ‚îÄ Results ‚îÄ‚îÄ */
.rv{display:none;flex-direction:column;align-items:center;justify-content:flex-start;flex:1;gap:6px;padding:16px 20px;overflow-y:auto}
.rv-ey{font-family:var(--m);font-size:.5rem;letter-spacing:4px;text-transform:uppercase;color:var(--t3)}
.rv-sc{font-family:var(--m);font-size:3.2rem;font-weight:700;color:var(--a);line-height:1;text-shadow:0 0 50px var(--ag)}
.rv-rk{font-size:.85rem;font-weight:200;letter-spacing:6px;text-transform:uppercase;color:var(--t2);margin-top:2px}
.rv-dt{font-family:var(--m);font-size:.5rem;color:var(--t3);margin-top:4px}
.rv-plot{width:100%;max-width:360px;border-radius:8px;margin:8px 0}
.rv-actions{display:flex;gap:8px;margin-top:8px}
.rv-btn{padding:10px 22px;border-radius:100px;border:1px solid var(--b);background:0;color:var(--t2);font-family:var(--f);font-size:.75rem;cursor:pointer;display:flex;align-items:center;gap:6px}
.rv-btn:active{background:var(--as);border-color:var(--a);color:var(--a)}
.rv-btn.primary{background:var(--as);border-color:rgba(0,255,204,.2);color:var(--a)}
.rv-copied{font-family:var(--m);font-size:.45rem;color:var(--a);opacity:0;transition:opacity .3s}.rv-copied.show{opacity:1}
/* ‚îÄ‚îÄ Calibration panel ‚îÄ‚îÄ */
.cp{display:none;flex-direction:column;flex:1;padding:16px 20px;overflow-y:auto}
.cp.open{display:flex}
.cp-title{font-size:1.1rem;font-weight:200;text-align:center;margin-bottom:2px}
.cp-step{font-family:var(--m);font-size:.5rem;letter-spacing:2px;text-transform:uppercase;color:var(--t3);text-align:center;margin-bottom:14px}
.cp-body{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px}
.cp-val{font-family:var(--m);font-size:1.8rem;font-weight:400;color:var(--a)}
.cp-hint{font-family:var(--m);font-size:.5rem;letter-spacing:1px;color:var(--t3);text-align:center;line-height:1.6}
.cp-msg{font-family:var(--m);font-size:.6rem;color:var(--t2);text-align:center;padding:16px;line-height:1.6}
.cp-slider{width:90%;max-width:300px}
.cp-slider input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:8px;background:rgba(255,255,255,.1);border-radius:4px;outline:0}
.cp-slider input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:32px;height:32px;border-radius:50%;background:var(--a);box-shadow:0 0 16px var(--ag);border:2px solid rgba(0,0,0,.2)}
.cp-nav{display:flex;gap:10px;justify-content:center;padding:16px 0;flex-shrink:0}
.cp-btn{padding:14px 32px;border-radius:100px;font-family:var(--f);font-size:.85rem;cursor:pointer;border:none;transition:all .2s var(--ez)}
.cp-back{background:0;color:var(--t2);border:1px solid var(--b)}.cp-back:active{border-color:rgba(255,255,255,.2);color:var(--t1)}
.cp-next{background:#fff;color:#0a0a0c}.cp-next:active{background:var(--a)}
.cp-start{background:var(--a);color:#0a0a0c;font-weight:500;font-size:.95rem;padding:16px 48px}
/* ‚îÄ‚îÄ Camera ‚îÄ‚îÄ */
.cam{display:none;position:fixed;inset:0;background:#000;z-index:500;flex-direction:column}
.cam.open{display:flex}
.cam video{flex:1;object-fit:cover}
.cam .hud{position:absolute;bottom:0;left:0;right:0;padding:20px;background:linear-gradient(transparent,rgba(0,0,0,.8));text-align:center}
.cam .inst{font-family:var(--m);font-size:.55rem;letter-spacing:2px;text-transform:uppercase;color:var(--t2);margin-bottom:12px}
.cam .cap{width:64px;height:64px;border-radius:50%;background:#fff;border:3px solid rgba(255,255,255,.3);cursor:pointer}
.cam .cap:active{transform:scale(.9)}
.cam .cx{position:absolute;top:14px;right:14px;background:rgba(0,0,0,.5);border:0;color:#fff;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:18px;z-index:1}
.cam .guide{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:75vw;height:75vw;border:2px dashed rgba(0,255,204,.3);border-radius:10px;pointer-events:none}
.cam .dbg{position:absolute;top:50px;left:10px;right:10px;font-family:var(--m);font-size:.4rem;color:rgba(0,255,204,.4);pointer-events:none;white-space:pre-line}
</style></head><body>

<div id="ctrl">
<div class="hdr"><span class="brand">BurkeCSF</span></div>
<div class="prog" id="prog"><div class="ring"><svg viewBox="0 0 48 48"><circle class="bg" cx="24" cy="24" r="21"/><circle class="fg" id="rfg" cx="24" cy="24" r="21"/></svg><div class="num" id="rnum">0</div></div></div>
<div class="resp" id="resp">
<div class="prompt" id="prompt">Tap a response to begin</div>
<div class="ori-pad" id="pad-ori">
<div class="ori-row">
<button class="ori-btn" onclick="send('upleft')">‚Üñ<span class="ori-lbl">Left</span></button>
<button class="ori-btn" onclick="send('up')">‚Üë<span class="ori-lbl">Vertical</span></button>
<button class="ori-btn" onclick="send('upright')">‚Üó<span class="ori-lbl">Right</span></button>
</div>
<div class="ori-row">
<button class="ori-btn" onclick="send('right')" style="max-width:40%;margin:0 auto">‚Üí<span class="ori-lbl">Horizontal</span></button>
</div>
<button class="no-btn" onclick="send('none')">No Target</button>
</div>
</div>
<div class="sbar" id="sbar"><div id="stt"><span class="sd" id="sdi"></span>Connecting</div><button class="rbtn" id="rbtn" onclick="location.reload()">Retry</button></div>
<div class="rv" id="rv">
<div class="rv-ey">Area Under Log CSF</div>
<div class="rv-sc" id="rsc">‚Äî</div><div class="rv-rk" id="rrk"></div><div class="rv-dt" id="rdt"></div>
<img class="rv-plot" id="rv-plot" style="display:none" alt="CSF curve">
<canvas id="rv-canvas" style="display:none" width="560" height="340"></canvas>
<div class="rv-actions">
<button class="rv-btn primary" onclick="shareR()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg> Share</button>
<button class="rv-btn" onclick="copyR()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg> Copy</button>
</div>
<div class="rv-copied" id="rv-cp">Copied</div>
</div>
</div>

<div class="cp" id="cp">
<div class="cp-step" id="cp-sl">Calibration</div>
<div class="cp-title" id="cp-tl">Linked to Display</div>
<div class="cp-body" id="cp-bd"><div class="cp-msg">Waiting for calibration step‚Ä¶</div></div>
<div class="cp-nav" id="cp-nv"></div>
</div>

<div class="cam" id="cam">
<button class="cx" onclick="closeCam()">‚úï</button>
<video id="cv" autoplay playsinline></video>
<div class="guide"></div>
<div class="dbg" id="cdbg"></div>
<div class="hud"><div class="inst" id="cinst">Point at display markers</div><button class="cap" id="ccap" onclick="capture()"></button></div>
<canvas id="cc" style="display:none"></canvas>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>if(typeof Peer==='undefined'){var s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js';document.head.appendChild(s)}</script>
<script>
const P=new URLSearchParams(location.search),laneID=P.get('id'),calID=P.get('cal'),camID=P.get('cam');
let diagMm=parseFloat(P.get('diagMm'))||0,conn=null,isConn=false;

// ‚ïê‚ïê‚ïê Hardware camera intrinsics lookup ‚ïê‚ïê‚ïê
// Focal length in mm and sensor width in mm for common devices
const CAM_DB={
    // iPhone wide cameras
    'Apple A17':'4.2/6.67','Apple A16':'5.7/7.01','Apple A15':'5.7/7.01','Apple A14':'4.25/5.1',
    'Apple A13':'4.25/5.1','Apple A12':'4.25/5.1','Apple GPU':'4.25/5.1',
    // Pixel phones
    'Adreno (TM) 750':'6.81/9.50','Adreno (TM) 740':'6.81/9.50','Adreno (TM) 730':'4.38/5.64',
    'Adreno (TM) 660':'4.38/5.64','Adreno (TM) 620':'4.44/5.76',
    // Samsung
    'Mali-G78':'5.4/7.06','Mali-G77':'5.4/7.06',
};

function getHardwareFocalPx(videoW){
    try{
        const c=document.createElement('canvas'),gl=c.getContext('webgl')||c.getContext('experimental-webgl');
        if(!gl)return null;
        const ext=gl.getExtension('WEBGL_debug_renderer_info');
        const gpu=ext?gl.getParameter(ext.UNMASKED_RENDERER_WEBGL):'';
        console.log('[Cam] GPU:',gpu);
        for(const[key,val]of Object.entries(CAM_DB)){
            if(gpu.includes(key)){
                const[fmm,sw]=val.split('/').map(Number);
                const fpx=(fmm/sw)*videoW;
                console.log('[Cam] Hardware match:',key,'focalPx=',fpx.toFixed(0));
                return fpx;
            }
        }
    }catch(e){}
    return null;
}

// Geometric calibration stored focal px
function getStoredFocalPx(){const v=localStorage.getItem('cam_focal_px');return v?parseFloat(v):null}
function storeFocalPx(f){localStorage.setItem('cam_focal_px',f.toString())}

// ‚ïê‚ïê‚ïê Routing ‚ïê‚ïê‚ïê
if(calID){document.getElementById('ctrl').style.display='none';document.getElementById('cp').classList.add('open');initCal(calID)}
else if(camID){document.getElementById('ctrl').style.display='none';document.getElementById('cp').classList.add('open');initStandaloneCam(camID)}
else if(laneID){initTest()}
else{setSt('er','No ID');document.getElementById('rbtn').style.display='inline-block'}

// ‚ïê‚ïê‚ïê Calibration mode ‚ïê‚ïê‚ïê
function initCal(pid){
    cpMsg('Connecting to display‚Ä¶');
    if(typeof Peer==='undefined'){cpMsg('PeerJS unavailable');return}
    const p=new Peer(undefined,{debug:1,config:{iceServers:[{urls:'stun:stun.l.google.com:19302'}]}});
    p.on('open',()=>{
        conn=p.connect(pid,{reliable:true});
        conn.on('open',()=>{isConn=true;cpMsg('Connected ‚Äî follow steps on display')});
        conn.on('data',onCalMsg);
        conn.on('close',()=>{isConn=false;cpMsg('Disconnected')});
    });
    p.on('error',e=>cpMsg('Error: '+e.type));
}

function onCalMsg(d){
    if(d.type==='calStep')renderCalStep(d.step,d);
    if(d.type==='startCam'){diagMm=d.diagMm;openCam()}
    if(d.type==='cancelCam')closeCam();
    if(d.type==='calComplete'){
        // Transition to test ‚Äî redirect this tab to connect as test controller
        // The display will reload to index.html and create a new PeerJS ID.
        // Show a "connecting to test" message, then user re-scans QR on test page.
        cpMsg('Calibration complete!<br><br>The test is loading on the display.<br>Scan the new QR code to connect as controller.');
        document.getElementById('cp-nv').innerHTML='';
    }
}

function renderCalStep(step,d){
    const bd=document.getElementById('cp-bd'),tl=document.getElementById('cp-tl'),sl=document.getElementById('cp-sl'),nv=document.getElementById('cp-nv');
    if(step===1){
        sl.textContent='STEP 2 ¬∑ LUMINANCE';tl.textContent='Adjust Brightness';
        bd.innerHTML=`<div class="cp-val" id="gval">128</div><div class="cp-slider"><input type="range" id="gsl" min="60" max="220" value="${d.gamma||128}" oninput="onGamma(this.value)"></div><div style="display:flex;justify-content:space-between;width:90%;max-width:300px;font-family:var(--m);font-size:.5rem;color:var(--t3)"><span>DARKER</span><span>BRIGHTER</span></div><div class="cp-hint">Adjust until the circle disappears<br>into the pattern on the display</div>`;
        nv.innerHTML='<button class="cp-btn cp-back" onclick="navCal(\'back\')">‚Üê Back</button><button class="cp-btn cp-next" onclick="navCal(\'next\')">Next ‚Üí</button>';
    }else if(step===2){
        sl.textContent='STEP 3 ¬∑ SCALE';tl.textContent='Card Size';
        bd.innerHTML=`<div class="cp-msg">Adjust the card outline on the display<br>to match a real credit card width.</div><div class="cp-slider"><input type="range" id="csl" min="150" max="750" step="0.1" value="${d.cardPx||300}" oninput="onCard(this.value)"></div><div style="display:flex;justify-content:space-between;width:90%;max-width:300px;font-family:var(--m);font-size:.5rem;color:var(--t3)"><span>SMALLER</span><span>LARGER</span></div>`;
        nv.innerHTML='<button class="cp-btn cp-back" onclick="navCal(\'back\')">‚Üê Back</button><button class="cp-btn cp-next" onclick="navCal(\'next\')">Next ‚Üí</button>';
    }else if(step===3){
        sl.textContent='STEP 4 ¬∑ DISTANCE';tl.textContent='Viewing Distance';
        bd.innerHTML='<button class="cp-btn cp-next" style="font-size:1rem;padding:20px 40px" onclick="triggerCam()">üì∑  Measure with Camera</button><div class="cp-hint" style="margin-top:12px">Or enter distance manually on display</div>';
        nv.innerHTML='<button class="cp-btn cp-back" onclick="navCal(\'back\')">‚Üê Back</button><button class="cp-btn cp-next" onclick="navCal(\'next\')">Review ‚Üí</button>';
    }else if(step===4){
        sl.textContent='STEP 5 ¬∑ CONFIRM';tl.textContent='Review Settings';
        bd.innerHTML='<div class="cp-msg">Review the settings on display.<br>Press Start when ready.</div>';
        nv.innerHTML='<button class="cp-btn cp-back" onclick="navCal(\'back\')">‚Üê Back</button><button class="cp-btn cp-start" onclick="navCal(\'start\')">Start Test ‚ñ∂</button>';
    }else{
        sl.textContent='CALIBRATION';tl.textContent='Connected';bd.innerHTML='<div class="cp-msg">Follow steps on display</div>';nv.innerHTML='';
    }
}

function onGamma(v){document.getElementById('gval').textContent=v;tx({type:'gamma',value:parseInt(v)})}
function onCard(v){tx({type:'cardSize',value:parseFloat(v)})}
function navCal(to){tx({type:'nav',to:to})}
function triggerCam(){tx({type:'nav',to:'next'});/* display will send startCam */}
function cpMsg(m){document.getElementById('cp-bd').innerHTML=`<div class="cp-msg">${m}</div>`}
function tx(m){if(conn&&isConn)conn.send(m)}

// ‚ïê‚ïê‚ïê Standalone camera ‚ïê‚ïê‚ïê
function initStandaloneCam(pid){
    cpMsg('Opening camera‚Ä¶');
    if(typeof Peer!=='undefined'){const p=new Peer(undefined,{config:{iceServers:[{urls:'stun:stun.l.google.com:19302'}]}});p.on('open',()=>{conn=p.connect(pid,{reliable:true});conn.on('open',()=>{isConn=true;openCam()})})}else openCam();
}

// ‚ïê‚ïê‚ïê Camera ‚ïê‚ïê‚ïê
let camStream=null;
function openCam(){
    document.getElementById('cam').classList.add('open');document.getElementById('ccap').style.display='';document.getElementById('cdbg').textContent='';
    document.getElementById('cinst').textContent='Point at display markers ‚Äî capture when visible';
    navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}}}).then(s=>{camStream=s;document.getElementById('cv').srcObject=s}).catch(e=>document.getElementById('cinst').textContent='Camera denied: '+e.message);
}
function closeCam(){document.getElementById('cam').classList.remove('open');if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null}}

function capture(){
    const v=document.getElementById('cv'),c=document.getElementById('cc');c.width=v.videoWidth;c.height=v.videoHeight;
    const ctx=c.getContext('2d');ctx.drawImage(v,0,0);
    const img=ctx.getImageData(0,0,c.width,c.height),markers=findMarkers(img,c.width,c.height),dbg=document.getElementById('cdbg');
    if(markers.length>=4){
        markers.sort((a,b)=>a.y-b.y);const top=markers.slice(0,2).sort((a,b)=>a.x-b.x),bot=markers.slice(2,4).sort((a,b)=>a.x-b.x);
        const dx=bot[1].x-top[0].x,dy=bot[1].y-top[0].y,dPx=Math.sqrt(dx*dx+dy*dy);
        // Get focal length: hardware ‚Üí stored ‚Üí default estimate
        let fPx=getHardwareFocalPx(c.width);
        let fSrc='hardware';
        if(!fPx){fPx=getStoredFocalPx();fSrc='stored'}
        if(!fPx){const hfov=70;fPx=(c.width/2)/Math.tan((hfov/2)*Math.PI/180);fSrc='default (70¬∞ hFOV)'}
        const distMm=(diagMm*fPx)/dPx;
        const ft=(distMm/304.8).toFixed(1),m=(distMm/1000).toFixed(2);
        dbg.textContent=[`Frame: ${c.width}√ó${c.height}`,`Markers: ${markers.length}`,`Diag photo: ${dPx.toFixed(0)}px`,`Real diag: ${diagMm.toFixed(0)}mm`,`focalPx: ${fPx.toFixed(0)} (${fSrc})`,`Distance: ${distMm.toFixed(0)}mm = ${ft}ft = ${m}m`,`TL(${top[0].x.toFixed(0)},${top[0].y.toFixed(0)}) BR(${bot[1].x.toFixed(0)},${bot[1].y.toFixed(0)})`].join('\n');
        tx({type:'camDistance',distMm:distMm});
        document.getElementById('cinst').textContent=`‚úì ${ft} ft (${m} m) ‚Äî sent`;document.getElementById('ccap').style.display='none';
        setTimeout(()=>closeCam(),2500);
    }else{
        dbg.textContent=`Found ${markers.length}/4 markers`;document.getElementById('cinst').textContent=`${markers.length}/4 markers ‚Äî reposition`;
    }
}

function findMarkers(img,w,h){
    const DK=70,MIN=40,dark=new Uint8Array(w*h);
    for(let i=0;i<w*h;i++){const r=img.data[i*4],g=img.data[i*4+1],b=img.data[i*4+2];dark[i]=(r<DK&&g<DK&&b<DK)?1:0}
    const vis=new Uint8Array(w*h),cls=[];
    for(let y=0;y<h;y++)for(let x=0;x<w;x++){const idx=y*w+x;if(!dark[idx]||vis[idx])continue;
        const stk=[idx];vis[idx]=1;let sx=0,sy=0,n=0;
        while(stk.length){const ci=stk.pop(),cx2=ci%w,cy2=(ci-cx2)/w;sx+=cx2;sy+=cy2;n++;
            for(const[dx,dy] of[[1,0],[-1,0],[0,1],[0,-1]]){const nx=cx2+dx,ny=cy2+dy;if(nx>=0&&nx<w&&ny>=0&&ny<h){const ni=ny*w+nx;if(dark[ni]&&!vis[ni]){vis[ni]=1;stk.push(ni)}}}}
        if(n>=MIN)cls.push({x:sx/n,y:sy/n,size:n})}
    cls.sort((a,b)=>b.size-a.size);return cls.slice(0,4);
}

// ‚ïê‚ïê‚ïê Test controller mode ‚ïê‚ïê‚ïê
let cto=null,curMode='gabor',resultData=null;
function initTest(){
    if(typeof Peer==='undefined'){setSt('er','Lib failed');return}
    const p=new Peer(undefined,{debug:1,config:{iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]}});
    cto=setTimeout(()=>{if(!isConn)setSt('er','Timed out')},15000);
    p.on('open',myId=>{setSt('','Syncing');conn=p.connect(laneID,{reliable:true});
        conn.on('open',()=>{clearTimeout(cto);isConn=true;setSt('ok','Linked');document.getElementById('rbtn').style.display='none'});
        conn.on('data',onTestMsg);conn.on('close',()=>{if(isConn){isConn=false;setSt('er','Disconnected')}});
        conn.on('error',e=>setSt('er',e.type));
    });
    p.on('error',e=>{clearTimeout(cto);setSt('er',e.type==='peer-unavailable'?'Display not found':e.type)});
    p.on('disconnected',()=>{if(!p.destroyed)p.reconnect()});
}

function onTestMsg(d){
    if(d.type==='state'){}// mode switching ‚Äî only gabor now
    if(d.type==='progress')updateRing(d.trial,d.maxTrials);
    if(d.type==='results')showResults(d.score,d.rank,d.detail);
    if(d.type==='results-extended')showExtResults(d);
}

function send(v){if(!conn||!isConn)return;conn.send({type:'input',value:v});if(navigator.vibrate)navigator.vibrate(25);document.getElementById('prompt').classList.add('hid');
    document.querySelectorAll('.ori-btn,.no-btn').forEach(b=>{b.classList.remove('fl');void b.offsetWidth;
        const bv=b.onclick?b.onclick.toString():'';if(bv.includes("'"+v+"'"))b.classList.add('fl')})}

function updateRing(t,mx){document.getElementById('rfg').style.strokeDashoffset=2*Math.PI*21*(1-t/mx);document.getElementById('rnum').textContent=t}

function showResults(sc,rk,dt){
    resultData={score:sc||'‚Äî',rank:rk||'',detail:dt||'',date:new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}),time:new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})};
    document.getElementById('resp').style.display='none';document.getElementById('prog').style.display='none';document.getElementById('sbar').style.display='none';
    const rv=document.getElementById('rv');rv.style.display='flex';
    document.getElementById('rsc').textContent=resultData.score;document.getElementById('rrk').textContent=resultData.rank;document.getElementById('rdt').textContent=resultData.detail;
}

function showExtResults(d){
    // Show plot image if available
    if(d.plotDataUrl){const img=document.getElementById('rv-plot');img.src=d.plotDataUrl;img.style.display='block'}
    // Or render from curve data
    else if(d.curve&&d.curve.length>0)renderTabletPlot(d.curve,d.history);
    if(d.score)resultData={...resultData,score:d.score,rank:d.rank,detail:d.detail};
}

function renderTabletPlot(curve,history){
    const c=document.getElementById('rv-canvas'),ctx=c.getContext('2d');
    c.style.display='block';c.style.width='100%';c.style.maxWidth='360px';c.style.borderRadius='8px';
    const W=560,H=340;c.width=W;c.height=H;
    const pad={top:20,right:24,bottom:50,left:60},pW=W-pad.left-pad.right,pH=H-pad.top-pad.bottom;
    const lfMin=-.3,lfMax=1.7,lsMin=-.3,lsMax=2.5;
    const tX=lf=>pad.left+(lf-lfMin)/(lfMax-lfMin)*pW;const tY=ls=>pad.top+pH-(ls-lsMin)/(lsMax-lsMin)*pH;
    ctx.fillStyle='#0a0a0c';ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=1;
    [0.5,1,2,4,8,16,32].forEach(f=>{const x=tX(Math.log10(f));if(x>=pad.left&&x<=pad.left+pW){ctx.beginPath();ctx.moveTo(x,pad.top);ctx.lineTo(x,pad.top+pH);ctx.stroke()}});
    [1,3,10,30,100,300].forEach(s=>{const y=tY(Math.log10(s));if(y>=pad.top&&y<=pad.top+pH){ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+pW,y);ctx.stroke()}});
    // Curve
    ctx.strokeStyle='#00ffcc';ctx.lineWidth=2.5;ctx.beginPath();let st=false;
    curve.forEach(pt=>{if(pt.logS<lsMin)return;const x=tX(Math.log10(pt.freq)),y=tY(Math.min(pt.logS,lsMax));if(!st){ctx.moveTo(x,y);st=true}else ctx.lineTo(x,y)});ctx.stroke();
    // History
    if(history)history.forEach(h=>{const x=tX(Math.log10(h.freq)),y=tY(-h.logContrast);if(y<pad.top||y>pad.top+pH)return;ctx.beginPath();ctx.arc(x,y,h.correct?3:2,0,Math.PI*2);ctx.fillStyle=h.correct?'rgba(0,255,150,.45)':'rgba(255,80,80,.4)';ctx.fill()});
    // Labels
    ctx.fillStyle='rgba(255,255,255,.3)';ctx.font='9px JetBrains Mono,monospace';ctx.textAlign='center';
    [0.5,1,2,4,8,16,32].forEach(f=>{const x=tX(Math.log10(f));if(x>=pad.left&&x<=pad.left+pW)ctx.fillText(String(f),x,pad.top+pH+14)});
    ctx.fillText('Spatial Frequency (cpd)',W/2,pad.top+pH+28);
    ctx.fillStyle='rgba(255,255,255,.15)';ctx.font='8px -apple-system,sans-serif';
    ctx.fillText('Level of Detail',W/2,pad.top+pH+40);
    ctx.font='7px JetBrains Mono,monospace';ctx.fillStyle='rgba(255,255,255,.12)';ctx.textAlign='left';ctx.fillText('‚Üê Coarse',pad.left,pad.top+pH+50);ctx.textAlign='right';ctx.fillText('Fine ‚Üí',pad.left+pW,pad.top+pH+50);
    ctx.textAlign='right';ctx.fillStyle='rgba(255,255,255,.3)';ctx.font='9px JetBrains Mono,monospace';
    [1,3,10,30,100,300].forEach(s=>{const y=tY(Math.log10(s));if(y>=pad.top&&y<=pad.top+pH)ctx.fillText(String(s),pad.left-8,y+3)});
    ctx.save();ctx.translate(13,H/2-10);ctx.rotate(-Math.PI/2);ctx.textAlign='center';ctx.fillText('Sensitivity',0,0);ctx.restore();
    ctx.strokeStyle='rgba(255,255,255,.08)';ctx.strokeRect(pad.left,pad.top,pW,pH);
}

function getRText(){if(!resultData)return '';return `BurkeCSF Results\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nAULCSF:  ${resultData.score}\nRating:  ${resultData.rank}\nDetail:  ${resultData.detail}\nDate:    ${resultData.date} ${resultData.time}\n\n‚Äî BurkeCSF`}
function shareR(){if(!resultData)return;const t=getRText(),s=`qCSF: AULCSF ${resultData.score}`;if(navigator.share)navigator.share({title:s,text:t}).catch(()=>{location.href=`mailto:?subject=${encodeURIComponent(s)}&body=${encodeURIComponent(t)}`});else location.href=`mailto:?subject=${encodeURIComponent(s)}&body=${encodeURIComponent(t)}`}
function copyR(){if(!resultData)return;navigator.clipboard.writeText(getRText()).then(fc).catch(()=>{const a=document.createElement('textarea');a.value=getRText();a.style.cssText='position:fixed;opacity:0';document.body.appendChild(a);a.select();document.execCommand('copy');document.body.removeChild(a);fc()})}
function fc(){const e=document.getElementById('rv-cp');e.classList.add('show');setTimeout(()=>e.classList.remove('show'),2000)}
function setSt(c,t){document.getElementById('stt').innerHTML=(c==='ok'?'<span class="sd ok"></span>':c==='er'?'<span class="sd er"></span>':'<span class="sd"></span>')+t;if(c==='er')document.getElementById('rbtn').style.display='inline-block'}
</script></body></html>
